<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="utf-8">
<title>Inky</title>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
	integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
	crossorigin="anonymous">
<link rel="stylesheet"
	href="https://use.fontawesome.com/releases/v5.12.1/css/all.css"
	integrity="sha384-v8BU367qNbs/aIZIxuivaU55N5GPF89WBerHoGA4QTcbUjYiLQtKdrfXnqAcXyTv"
	crossorigin="anonymous">
<link rel="stylesheet" href="/css/style.css">
<style>
.card{
height:700px;
}
</style>
</head>
<body>
	<div class="container">
		<div class="d-flex justify-content-center h-100">
			<div class="card">
				<div class="card-header">
					<h3>회원가입</h3>
				</div>
				<div class="card-body">
					<form method="post" id="joinForm">
						<div class="input-group form-group">
							<input type="text" id="username" name="uid" class="form-control"
								placeholder="아이디">
							<button class="btn float-right member_btn" id="chkid">중복확인</button>
						</div>
						<div class="input-group form-group">
							<input type="password" class="form-control" id="password"
								name="upw" placeholder="비밀번호">
						</div>
						<div class="input-group form-group">
							<input type="password" class="form-control" id="password"
								name="upwchk" placeholder="비밀번호확인">
						</div>
						<div class="input-group form-group" id="emailform">
							<input type="text" id="uemail" name="uemail" class="form-control"
								placeholder="이메일">
							<button class="btn float-right member_btn" id="chkemail">인증하기</button>
						</div>
						<div class="input-group mb-3 profile-div">
							<div class="input-group-prepend">
								<i class="input-group-text" id="inputGroupFileAddon01">프로필</i>
							</div>
							<div class="custom-file">
								<input type="file" class="custom-file-input"
									id="inputGroupFile01" aria-describedby="inputGroupFileAddon01"
									name="uploadfile"> <label class="custom-file-label"
									for="inputGroupFile01">Choose file</label>
							</div>
						</div>
						<div class='profile-img form-group text-center'></div>
						<div class="input-group form-group">
							<input type="text" id="uname" name="uname" class="form-control"
								placeholder="사용자이름">
						</div>
						<input type="hidden" th:name="${_csrf.parameterName}"
							th:value="${_csrf.token}" />
						<div class="form-group">
							<input type="submit" value="회원가입" id="join"
								class="btn float-right member_btn">
						</div>
					</form>
				</div>
				<div class="card-footer">
					<div class="d-flex justify-content-center">
						<a href="#">돌아가기</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="modal"><!-- Place at bottom of page --></div>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js">
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
		integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
		crossorigin="anonymous">
	</script>
	<script
		src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
		integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
		crossorigin="anonymous"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
		integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
		crossorigin="anonymous"></script>
	<script src="https://kit.fontawesome.com/addd4c8dc0.js"
		crossorigin="anonymous"></script>
		<script th:inline="javascript">
			$body = $("body");

			$(document).on({
   				ajaxStart: function() { $body.addClass("loading");    },
     			ajaxStop: function() { $body.removeClass("loading"); }    
			});
		</script>
	<script th:inline="javascript">
		$(document).ready(function() {
			var csrf = JSON.parse('[[${_csrf}]]');
			var formObj = $("#joinForm");
			var profileFile = null;
			$("#inputGroupFile01").on("change",function(e) {
				console.log("fileUpload");
				$.ajax({
					url : "/profileUpload",
					type : "POST",
					data : new FormData($("#joinForm")[0]),
					enctype : 'multipart/form-data',
					processData : false,
					contentType : false,
					cache : false,
					success : function(data) {
							console.log(data);
							profileFile = data;
							$(".profile-img").html("<img src='"+data+"'/><button class='btn btn-primary cancel-btn'><i class='fas fa-times'></i></button>");
							$(".cancel-btn").on("click",function(e) {
								profileFile = null;
								$(".profile-img img").remove();
								$(this).remove();
							});
					},
					error : function(error) {
						console.log(error);
					}
				});
			});
			$("#chkid").on("click",function(e) {
				e.preventDefault();
				var uid = formObj.find("[name='uid']").val();
				$.ajax({
					type : 'post',
					url : '/member/checkid',
					data : uid,
					contentType : "text/plain",
					beforeSend : function(xhr) {
						xhr.setRequestHeader(csrf.headerName,csrf.token);
					},
					success : function(result) {
						alert(result);
					},
					error : function(result) {
						alert(result.responseText);
					}
				});
			});
			$("#chkemail").on("click",function(e) {
				e.preventDefault();
				var uemail = formObj.find("[name='uemail']").val();
				console.log(uemail);
				$.ajax({
					type : 'post',
					url : '/member/sendEmail',
					data : uemail,
					contentType : "text/plain",
					beforeSend : function(xhr) {
						xhr.setRequestHeader(csrf.headerName,csrf.token);
					},
					success : function(result) {
						alert(result);
					},
					error : function(result) {
						alert("이메일을 보내지 못했습니다. 이메일 주소가 맞지 않거나 이미 존재하는 이메일일 수 있습니다.");
						$("#chkcodeForm").remove();
					}
				});
				var str = "";
				str += "<div class='input-group form-group' id='chkcodeForm'>";
				str += "	<input type='text' id='code' name='code' class='form-control' placeholder='인증코드'>";
				str += "	<button class='btn float-right member_btn' id='chkcode'>인증하기</button>";
				str += "</div>";
				$("#chkcodeForm").remove();
				$("#emailform").after(str);
				$("#chkcode").on("click",function(e) {
					e.preventDefault();
					var chkcode = $("#code").val();
					var sendData = {
						email : uemail,
						code : chkcode
					};
					$.ajax({
						type : 'post',
						url : '/member/checkEmail',
						data : JSON.stringify(sendData),
						contentType : "application/json",
						beforeSend : function(xhr) {
							xhr.setRequestHeader(csrf.headerName,csrf.token);
						},
						success : function(result) {
							alert(result);
							$("#chkcodeForm").remove();
						},
						error : function(result) {
							alert(result.responseText);
						}
					});
				});
			});
			$("#join").on("click",function(e) {
				e.preventDefault();
				var uploadPath;
				var uploadfileName;
				var fForm = [];
				if (profileFile != null) {
					var firstIdx = profileFile.indexOf('/',1);
					var lastIdx = profileFile.lastIndexOf('/');
					uploadPath = profileFile.substring(firstIdx + 1, lastIdx);
					uploadfileName = profileFile.substring(lastIdx + 1);
					fForm.push({
						uploadPath : uploadPath,
						uploadFileName : uploadfileName
					});
				}
				var uid = formObj.find("[name='uid']").val();
				var upw = formObj.find("[name='upw']").val();
				var upwchk = formObj.find("[name='upwchk']").val();
				var uemail = formObj.find("[name='uemail']").val();
				var uname = formObj.find("[name='uname']").val();
				if (upw != upwchk) {
					alert("비밀번호와 비밀번호 확인이 맞지 않습니다.");
					return;
				}
				var sendData = {
					uid : uid,
					upw : upw,
					uemail : uemail,
					uname : uname,
					uploads : fForm
				};
				console.log(sendData);
				$.ajax({
					type : 'post',
					url : '/member/join',
					data : JSON.stringify(sendData),
					contentType : "application/json",
					beforeSend : function(xhr) {
						xhr.setRequestHeader(csrf.headerName,csrf.token);
					},
					success : function(result) {
						alert(result);
						location.href="/login";
					},
					error : function(result) {
					alert(result.responseText);
					}
				});
			});

		});
</script>
</body>

</html>